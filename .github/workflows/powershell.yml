name: PowerShell Lint ve Test

on:
  push:
    branches: [ main, develop ]
    paths:
      - '*.ps1'
      - '.github/workflows/powershell.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '*.ps1'

jobs:
  lint:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: PowerShell Syntax Kontrol√º
      shell: powershell
      run: |
        # WinDeploy.ps1 syntax kontrol
        $script:ScriptErrors = @()
        
        try {
          $null = [System.Management.Automation.PSParser]::Tokenize(
            (Get-Content -Path "WinDeploy.ps1" -Raw),
            [ref]$null
          )
          Write-Host "‚úì WinDeploy.ps1: Syntax OK"
        }
        catch {
          $script:ScriptErrors += "WinDeploy.ps1: $_"
          Write-Host "‚úó WinDeploy.ps1: Syntax Error"
        }
        
        try {
          $null = [System.Management.Automation.PSParser]::Tokenize(
            (Get-Content -Path "launcher.ps1" -Raw),
            [ref]$null
          )
          Write-Host "‚úì launcher.ps1: Syntax OK"
        }
        catch {
          $script:ScriptErrors += "launcher.ps1: $_"
          Write-Host "‚úó launcher.ps1: Syntax Error"
        }
        
        if ($script:ScriptErrors.Count -gt 0) {
          Write-Host "`nHatalar:" -ForegroundColor Red
          $script:ScriptErrors | ForEach-Object { Write-Host "  - $_" }
          exit 1
        }
    
    - name: PSScriptAnalyzer Kontrol√º
      shell: powershell
      run: |
        Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
        
        Write-Host "WinDeploy.ps1 analizi:" -ForegroundColor Cyan
        Invoke-ScriptAnalyzer -Path "WinDeploy.ps1" -ReportSummary
        
        Write-Host "launcher.ps1 analizi:" -ForegroundColor Cyan
        Invoke-ScriptAnalyzer -Path "launcher.ps1" -ReportSummary
      continue-on-error: true
  
  security:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: G√ºvenlik Kontrolleri
      shell: powershell
      run: |
        Write-Host "üîç G√ºvenlik Kontrolleri √áalƒ±≈ütƒ±rƒ±lƒ±yor..." -ForegroundColor Cyan
        
        # Kritik terimleri ara
        $kritikTerimler = @("system32", "Format-C:", "Remove-Item * -Recurse", "Get-Credential")
        
        foreach ($file in @("WinDeploy.ps1", "launcher.ps1")) {
          $content = Get-Content $file -Raw
          foreach ($terim in $kritikTerimler) {
            if ($content -like "*$terim*") {
              Write-Host "‚ö†Ô∏è Dikkat: '$terim' bulundu $file i√ßinde"
            }
          }
        }
        
        Write-Host "‚úì G√ºvenlik kontrolleri tamamlandƒ±" -ForegroundColor Green
